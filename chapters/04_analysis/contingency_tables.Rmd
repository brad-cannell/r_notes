# Contingency Tables

<!--
Don't forget to add code for converting from a contingency table back into raw data. See the useful websites below. 
-->

```{r echo=FALSE}
knitr::include_graphics("https://picsum.photos/200/300")
```

## ‚≠êÔ∏èOverview

In Epi III (and epidemiology in general) we use a lot of contingency tables - especially 2x2 contingency tables. In this note, we play around with several different ways of creating contingency tables and explore the pros and cons of each.


## üåéUseful websites

* [Boston University](https://sphweb.bumc.bu.edu/otlt/mph-modules/ep/ep713_association/ep713_association_print.html)

* [Tables in R ‚Äì A quick practical overview](https://cran.r-project.org/web/packages/DescTools/vignettes/TablesInR.pdf). By Andri Signorell.

* [Stack Overflow: Repeat each row of data.frame the number of times specified in a column](https://stackoverflow.com/questions/2894775/repeat-each-row-of-data-frame-the-number-of-times-specified-in-a-column)

* [Cookbook for R](https://www.bookstack.cn/read/cookbook-r-en/781d02230715aca4.md)


## üì¶Load packages

```{r message=FALSE}
library(dplyr, warn.conflicts = FALSE)
```


## Scenario

This scenario is borrowed from the [Boston University](https://sphweb.bumc.bu.edu/otlt/mph-modules/ep/ep713_association/ep713_association_print.html) website. 

Data Summary

Consider the following example regarding the management of Hodgkin lymphoma, a cancer of the lymphatic system. Years ago when a patient was diagnosed with Hodgkin Disease, they would frequently undergo a surgical procedure called a "staging laparotomy." The purpose of the staging laparotomy was to determine the extent to which the cancer had spread, because this was important information for determining the patient's prognosis and optimizing treatment. At times, the surgeons performing this procedure would also remove the patient's appendix, not because it was inflamed; it was done "incidentally" in order to ensure that the patient never had to worry about getting appendicitis. However, performing an appendectomy requires transecting it, and this has the potential to contaminate the abdomen and the wound edges with bacteria normally contained inside the appendix. Some surgeons felt that doing this "incidental appendectomy" did the patient a favor by ensuring that they would never get appendicitis, but others felt that it meant unnecessarily increasing the patient's risk of getting a post-operative wound infection by spreading around the bacteria that was once inside the appendix. To address this, the surgeons at a large hospital performed a retrospective cohort study. They began by going through the hospital's medical records to identify all subjects who had had a "staging laparotomy performed for Hodgkin." They then reviewed the medical record and looked at the operative report to determine whether the patient had an incidental appendectomy or not. They then reviewed the progress notes, the laboratory reports, the nurses notes, and the discharge summary to determine whether the patient had developed a wound infection during the week after surgery. The investigators reviewed the records of 210 patients who had undergone the staging procedure and found that 131 had also had an incidental appendectomy, while the other 79 had not. The data from that study are summarized in the table below. The numbers in the second and third columns indicate the number of subjects who did or did not develop a post-operative wound infection among those who had the incidental appendectomy (in the "Yes" row) and those who did not have the incidental appendectomy (in the "No" row). For example, the upper left cell indicates that seven of the subjects who had an incidental appendectomy (the exposure of interest) subsequently developed a wound infection. The upper right cell indicates that the other 124 subjects who had an incidental appendectomy did NOT develop a wound infection.

|                              |                 |                    |       |
|------------------------------|-----------------|--------------------|-------|
| Had incidental appendectomy? | Wound infection | No wound infection | Total |
| Yes                          | 7               | 124                | 131   |
| No                           | 1               | 78                 | 79    |
| Total                        | 8               | 202                | 210   |


## Manually create data

First, we can manually create tibble with one row for each person represented in the data above. Ordinarily, this is how the data would come to us. Then, we can use various different techniques -- some of which are demonstrated below -- to summarize the data as a 2x2 contingency table. In this case, we are working backwards from the data summary to the raw data just to show one way that it can be done. This isn't necessarily a good way to do it, however. Later, we will demonstrate more efficient and less error-prone ways to create raw data from summary tables. 

```{r}
df <- tibble(
  appendectomy = factor(c(rep("Yes", 7), rep("Yes", 124), "No", rep("No", 78))),
  infection    = factor(c(rep("Yes", 7), rep("No", 124), "Yes", rep("No", 78)))
)

df
```

## Matrix

Create a contingency table using a matrix object. 

```{r}
matrix <- matrix(
  c(a = 7, b = 124, c = 1, d = 78),
  ncol = 2,
  byrow = TRUE
)

# Add names to make the matrix more readable
rownames(matrix) <- c("Appendectomy", "No Appendectomy")
colnames(matrix) <- c("Infection", "No Infection")

matrix
```

Adding summary rows/columns to the matrix.

```{r}
matrix_w_margins <- cbind(matrix, rowsum = rowSums(matrix))
matrix_w_margins <- rbind(matrix_w_margins, colsum = colSums(matrix_w_margins))
matrix_w_margins
```

## Table

You can coerce a matrix object into a table object. I haven't found a way to create a table object from scratch (i.e., without making a matrix or data frame first).

```{r}
table <- as.table(matrix)
table
```

```{r}
# Add margins
table_w_margins <- addmargins(table)
table_w_margins
```

Aside from adding margins in one step, it isn't clear what the advantage of coercing the matrix to a table is at this point. However, there may be advantages later when we calculate incidence and other measures of occurrence and association. 

## Base R data frame with rownames

Create from scratch:

```{r}
df <- data.frame(
  Infection = c(7, 1),
  `No Infection` = c(124, 78)
)

# Add row names
rownames(df) <- c("Appendectomy", "No Appendectomy")

df
```

Add margins:

```{r}
df_w_margins <- df
df_w_margins <- cbind(df_w_margins, rowsum = rowSums(df_w_margins))
df_w_margins <- rbind(df_w_margins, colsum = colSums(df_w_margins))
df_w_margins
```

As far as I can tell, there doesn't seem to be an advantage to creating a df from scratch over creating a matrix from scratch. 

Create a base R data frame by coercing the matrix object to a data frame:

```{r}
df_w_margins <- as.data.frame(matrix_w_margins)
df_w_margins
```

Coercing the table object to a data frame gives a different result:

```{r}
as.data.frame(table)
```

At this point, I think it still makes sense to start with a matrix. You can easily convert a matrix to a data frame later if you need to. 

## Tibble

Unlike the other objects, this object won't have the standard contingency table layout. 

```{r}
tbl <- tribble(
  ~appendectomy, ~infection, ~count,
  "Yes", "Yes", 7,
  "Yes", "No",  124,
  "No",  "Yes", 1,
  "No",  "No",  78
)

# Add margins
tbl %>% 
  group_by(appendectomy) %>% 
  mutate(appendectomy_totals = sum(count)) %>% 
  group_by(infection) %>% 
  mutate(infection_totals = sum(count)) %>% 
  ungroup() %>% 
  mutate(margin_total = sum(count))
```

This layout can be useful, but this note is really about working with a contingency table layout. 

<!--
Clean up and add session info
-->

```{r echo=FALSE}
rm(list = ls())
```


